<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EQ Visit Tracker</title>
  <meta name="theme-color" content="#145AFF" />
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root { --brand:#145AFF; --bg:#f7f9fc; --card:#fff; --muted:#6b7280; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color:#111827; }
    header { position: sticky; top:0; z-index: 10; background:#fff; border-bottom:1px solid #e5e7eb; padding:.5rem 1rem; display:flex; align-items:center; gap:.75rem; }
    header h1 { font-size:1.1rem; margin:0; color:var(--brand); }
    .grow{ flex:1; }
    .card { background:var(--card); border:1px solid #e5e7eb; border-radius:14px; padding:1rem; }
    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .btn { background:var(--brand); color:#fff; border:0; padding:.55rem .9rem; border-radius:12px; cursor:pointer; }
    .btn.outline { background:transparent; color:var(--brand); border:1px solid var(--brand); }
    .btn.light { background:#e5edff; color:var(--brand); }
    .btn.danger { background:var(--bad); }
    .input, select { padding:.55rem .65rem; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:.75rem; }
    .pill { display:inline-block; padding:.2rem .5rem; border-radius:999px; font-size:.75rem; border:1px solid #e5e7eb; background:#fff; }
    .pill.ok { border-color:var(--ok); color:var(--ok); }
    .pill.warn { border-color:var(--warn); color:var(--warn); }
    .pill.bad { border-color:var(--bad); color:var(--bad); }
    nav { display:flex; gap:.5rem; }
    main { padding:1rem; max-width:1100px; margin:0 auto; display:grid; gap:1rem; }
    .muted { color:var(--muted); }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:.5rem; border-bottom:1px solid #e5e7eb; text-align:left; }
    .section-title { margin:.25rem 0 .25rem; font-size:.95rem; color:#374151; }
    .thbtn { background:transparent; border:0; cursor:pointer; font:inherit; padding:0; color:#111827; }
    .thbtn span { margin-left:.25rem; color:#6b7280; }
  </style>
</head>
<body>
  <header class="card">
    <h1>EQ Visit Tracker</h1>
    <nav>
      <button class="btn light" onclick="showView('next')">Next Up</button>
      <button class="btn light" onclick="showView('elders')">Directory</button>
      <button class="btn light" onclick="showView('log')">Log Visit</button>
      <button class="btn light" onclick="showView('import')">Import</button>
    </nav>
    <div class="grow"></div>
    <div id="authBox" style="display:flex;gap:.5rem;align-items:center">
      <span id="currentUser" class="muted"></span>
      <input id="email" class="input" placeholder="Email" autocomplete="username">
      <input id="password" class="input" type="password" placeholder="Password" autocomplete="current-password">
      <button class="btn" id="signinBtn" onclick="signIn()">Sign in</button>
      <button class="btn outline" id="createBtn" onclick="create()">Create</button>
      <button class="btn danger" id="logoutBtn" onclick="signOut()" style="display:none">Sign out</button>
    </div>
  </header>

  <main>
    <section id="view-next" class="card" style="display:none">
      <div class="toolbar">
        <input id="searchNext" class="input" placeholder="Search name/phone/email/address">
        <button class="btn outline" id="btnSearchNext">Search</button>
        <button class="btn outline" onclick="pickThisWeek()">Pick next elder (for this week)</button>
        <div class="grow"></div>
        <span id="yearRemaining" class="muted"></span>
      </div>
      <div class="section-title" style="display:flex;justify-content:space-between;align-items:center">
        <span>Top candidates</span>
      </div>
      <div id="nextGrid" class="grid"></div>
    </section>

    <section id="view-elders" class="card" style="display:none">
      <div class="toolbar">
        <input id="searchElders" class="input" placeholder="Search name/phone/address/email">
        <button class="btn outline" id="btnSearchElders">Search</button>
        <button class="btn outline" onclick="addElderPrompt()">Quick add</button>
        <div class="grow"></div>
        <span id="eldersCount" class="muted"></span>
      </div>
      <table>
        <thead>
          <tr>
            <th><button class="thbtn" onclick="setSort('name')">Name <span id="sort-name"></span></button></th>
            <th><button class="thbtn" onclick="setSort('phone')">Phone <span id="sort-phone"></span></button></th>
            <th><button class="thbtn" onclick="setSort('visited')">Last visited <span id="sort-visited"></span></button></th>
            <th><button class="thbtn" onclick="setSort('attempts')">Attempts <span id="sort-attempts"></span></button></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="eldersTbody"></tbody>
      </table>
    </section>

    <section id="view-log" class="card" style="display:none">
      <div class="toolbar">
        <select id="logElderSelect"></select>
        <input type="date" id="logDate" class="input">
        <select id="logOutcome" class="input">
          <option>Visited</option>
          <option>Scheduled</option>
          <option>No answer</option>
          <option>Reschedule</option>
        </select>
        <input id="logVisitors" class="input" placeholder="Visitors (e.g., Presidency)">
      </div>
      <textarea id="logNotes" class="input" placeholder="Notes" style="width:100%; height:90px; margin-top:.5rem"></textarea>
      <div style="margin-top:.5rem">
        <button class="btn" onclick="saveVisit()">Save visit</button>
      </div>
    </section>

    <section id="view-import" class="card" style="display:none">
      <div class="section-title">Import Elders CSV (see template)</div>
      <input type="file" id="csvFile" accept=".csv">
      <div style="margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap">
        <button class="btn" onclick="importCsv()">Import &amp; Dedupe</button>
        <button class="btn outline" onclick="exportBackup()">Export backup (JSON)</button>
        <button class="btn outline" onclick="exportCsv()">Export CSV</button>
        <button class="btn danger" onclick="fixDuplicates()">Fix duplicates</button>
        <a class="btn outline" href="elders_template.csv" download>Download template</a>
      </div>
      <p class="muted" style="margin-top:.5rem">
        Import is idempotent (safe to run multiple times). Missing records become <b>inactive</b>. Visit history is preserved.
      </p>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      initializeFirestore, persistentLocalCache, persistentMultipleTabManager,
      collection, doc, addDoc, setDoc, updateDoc, deleteDoc, getDocs,
      onSnapshot, query, where, serverTimestamp, increment
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // ---- Firebase config ----
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCWhXRTryqXRoiRNBSFrWiB-RzmYJ-TQXM",
      authDomain: "southpass-elders-visit-tracker.firebaseapp.com",
      projectId: "southpass-elders-visit-tracker",
      storageBucket: "southpass-elders-visit-tracker.firebasestorage.app",
      messagingSenderId: "736973707480",
      appId: "1:736973707480:web:0bb5ead0d5b43d55bb9fad",
      measurementId: "G-JQKNSH8CTB"
    };
    console.log('Using Firebase API key:', FIREBASE_CONFIG.apiKey);

    // SW
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js?v=1'));
    }

    // Firebase init
    const app = initializeApp(FIREBASE_CONFIG);
    const db = initializeFirestore(app, {
      localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
    });
    const auth = getAuth(app);

    // State
    let unsubElders = null, unsubVisits = null;
    let currentUser = null;
    const elders = new Map();
    const visits = [];

    // Helpers
    const q = (id)=>document.getElementById(id);
    const cleanPhone = (s)=> (s||'').replace(/\D/g,'');
    const norm = (s)=> (s||'').toString().trim().toLowerCase();
    const fmtDate = (ts)=> { if (!ts) return 'â€”'; const d = ts?.toDate ? ts.toDate() : new Date(ts); return d.toLocaleDateString(); };
    const daysSince = (ts)=> { if (!ts) return null; const d = ts?.toDate ? ts.toDate() : new Date(ts); return Math.floor((Date.now()-d.getTime())/86400000); };
    const asMs = (t)=> t ? (t.toDate ? t.toDate().getTime() : new Date(t).getTime()) : 0;
    const maxDate = (a,b)=> asMs(a) >= asMs(b) ? a : b;
    const hash = (str)=>{ let h=5381; for (let i=0;i<str.length;i++) h=((h<<5)+h)^str.charCodeAt(i); return 'k_'+(h>>>0).toString(36); };

    function startOfYear(d=new Date()){ return new Date(d.getFullYear(),0,1,0,0,0,0); }

    function updateAuthUI(user){
      const signedOut = !user;
      ['email','password','signinBtn','createBtn'].forEach(id => q(id).style.display = signedOut ? 'inline-block' : 'none');
      q('logoutBtn').style.display = user ? 'inline-block' : 'none';
      q('currentUser').textContent = user ? user.email : '';
      if (user){ q('email').value = ''; q('password').value = ''; }
    }

    const SETTINGS = { W_DAYS: 0.2, W_ATTEMPTS: 5, BONUS_NEVER: 30, PENALTY_RECENT_CONTACT: -20, COOLDOWN_DAYS: 14 };
    function nextUpScore(e){
      if (e.active === false || e.doNotText) return -999;
      const days = e.lastVisited ? daysSince(e.lastVisited) : null;
      const daysScore = (days === null ? SETTINGS.BONUS_NEVER : days * SETTINGS.W_DAYS);
      const attemptsScore = (e.attemptsSinceLastVisit || 0) * SETTINGS.W_ATTEMPTS;
      const lcd = e.lastContacted ? daysSince(e.lastContacted) : null;
      const recentPenalty = (lcd !== null && lcd < SETTINGS.COOLDOWN_DAYS) ? SETTINGS.PENALTY_RECENT_CONTACT : 0;
      return daysScore + attemptsScore + recentPenalty;
    }

    function userCol(path){ if (!currentUser) throw new Error('Not signed in'); return collection(db, 'users', currentUser.uid, path); }

    function subscribeData(){
      unsubElders = onSnapshot(userCol('elders'), (snap)=>{
        snap.docChanges().forEach(ch=>{
          if (ch.type === 'removed') elders.delete(ch.doc.id);
          else elders.set(ch.doc.id, { id: ch.doc.id, ...ch.doc.data() });
        });
        renderAll();
      });
      unsubVisits = onSnapshot(userCol('visits'), (snap)=>{
        visits.length = 0;
        snap.forEach(d => visits.push({ id: d.id, ...d.data() }));
        renderAll();
      });
    }
    function unsubscribeData(){ if (unsubElders) unsubElders(); if (unsubVisits) unsubVisits(); }

    // Auth
    onAuthStateChanged(auth, (user)=>{
      currentUser = user;
      updateAuthUI(user);
      if (user) subscribeData(); else { unsubscribeData(); elders.clear(); visits.length=0; renderAll(); }
    });

    window.signIn = async ()=>{ try{
      await signInWithEmailAndPassword(auth, q('email').value.trim(), q('password').value.trim());
    }catch(e){ console.error('signIn error:', e); alert('Sign-in failed: '+(e.message||e.code)); } };
    window.create = async ()=>{ try{
      await createUserWithEmailAndPassword(auth, q('email').value.trim(), q('password').value.trim());
    }catch(e){ console.error('create error:', e); alert('Create failed: '+(e.message||e.code)); } };
    window.signOut = async ()=>{ try{ await signOut(auth); }catch(e){ alert('Sign-out failed: '+(e.message||e.code)); } };

    // ---------- Sorting & Search ----------
    let sortBy = 'name', sortDir = 'asc'; // default
    window.setSort = (key)=>{
      if (sortBy === key) sortDir = (sortDir==='asc' ? 'desc' : 'asc');
      else { sortBy = key; sortDir = (key==='visited' ? 'desc' : 'asc'); }
      renderElders();
    };
    function updateSortArrows(){
      ['name','phone','visited','attempts'].forEach(k=>{
        const el = q('sort-'+k);
        if (!el) return;
        el.textContent = (sortBy===k) ? (sortDir==='asc' ? 'â–²' : 'â–¼') : '';
      });
    }

    function filterByTokens(e, tokens){
      if (!tokens.length) return true;
      const hay = (norm(e.preferredName)+' '+norm(e.lastName)+' '+norm(e.email)+' '+norm(e.address)+' '+cleanPhone(e.phone||''));
      return tokens.every(t => hay.includes(t));
    }

    // expose renderers
    window.renderNext = renderNext;
    window.renderElders = renderElders;

    // Wire up search buttons & Enter key
    const wireSearch = () => {
      q('btnSearchElders')?.addEventListener('click', ()=>renderElders());
      q('searchElders')?.addEventListener('keydown', e=>{ if(e.key==='Enter') renderElders(); });
      q('searchElders')?.addEventListener('input', ()=>renderElders());

      q('btnSearchNext')?.addEventListener('click', ()=>renderNext());
      q('searchNext')?.addEventListener('keydown', e=>{ if(e.key==='Enter') renderNext(); });
      q('searchNext')?.addEventListener('input', ()=>renderNext());
    };

    // ---------- Counters ----------
    function updateCounters(){
      const all = Array.from(elders.values());
      const active = all.filter(e=>e.active!==false);
      const jan1 = startOfYear();
      const remaining = active.filter(e => !e.lastVisited || asMs(e.lastVisited) < jan1.getTime()).length;
      const yr = q('yearRemaining'); if (yr) yr.textContent = `Remaining this year: ${remaining}`;
      const ec = q('eldersCount'); if (ec) ec.textContent = `Total: ${all.length} (${active.length} active)`;
    }

    // UI
    window.showView = (name)=> {
      ['next','elders','log','import'].forEach(v=>q('view-'+v).style.display = (v===name)?'block':'none');
      if (name==='log') fillLogSelect();
      updateSortArrows();
      updateCounters();
    };
    function renderAll(){ renderNext(); renderElders(); fillLogSelect(); updateSortArrows(); updateCounters(); }

    function renderNext(){
      const grid = q('nextGrid');
      const tokens = norm(q('searchNext').value).split(/\s+/).filter(Boolean);
      const arr = Array.from(elders.values()).map(e=>({ ...e, _score: nextUpScore(e) }))
        .filter(e=> e._score > -999 && filterByTokens(e, tokens))
        .sort((a,b)=> b._score - a._score)
        .slice(0,18);

      grid.innerHTML = arr.map(e=>{
        const ds = e.lastVisited ? daysSince(e.lastVisited) : null;
        const status = ds === null ? 'warn' : (ds >= 30 ? 'bad' : (ds >= 14 ? 'warn' : 'ok'));
        const diff = ds === null ? 'Never' : (ds + 'd');
        const smsUrl = `sms:+1${cleanPhone(e.phone||'')}?&body=${encodeURIComponent(`Hi ${e.preferredName||e.lastName||'there'}, this is the Elders Quorum Presidency. Could we stop by Wednesday evening for a short visit?`)}`;
        return `
          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <div><b>${(e.preferredName||'') + ' ' + (e.lastName||'')}</b></div>
              <span class="pill ${status}">${diff}</span>
            </div>
            <div class="muted" style="margin:.25rem 0">${e.phone||''}</div>
            <div style="display:flex; gap:.5rem; margin-top:.25rem">
              <a class="btn outline" href="${smsUrl}">Text</a>
              <button class="btn" onclick="quickLogVisit('${e.id}')">Log now</button>
              <button class="btn outline" onclick="noAnswer('${e.id}')">No answer</button>
            </div>
          </div>`;
      }).join('');
    }

    function renderElders(){
      const tb = q('eldersTbody');
      const tokens = norm(q('searchElders').value).split(/\s+/).filter(Boolean);
      let arr = Array.from(elders.values()).filter(e=>filterByTokens(e, tokens));

      // sorting
      const dir = (sortDir==='asc') ? 1 : -1;
      const cmpName = (a,b)=> ((a.lastName||'').localeCompare(b.lastName||'') || (a.preferredName||'').localeCompare(b.preferredName||'')) * dir;
      const cmpPhone = (a,b)=> cleanPhone(a.phone||'').localeCompare(cleanPhone(b.phone||'')) * dir;
      const cmpVisited = (a,b)=> (asMs(a.lastVisited) - asMs(b.lastVisited)) * dir;
      const cmpAttempts = (a,b)=> ((a.attemptsSinceLastVisit||0) - (b.attemptsSinceLastVisit||0)) * dir;
      const cmps = { name:cmpName, phone:cmpPhone, visited:cmpVisited, attempts:cmpAttempts };
      arr.sort(cmps[sortBy] || cmpName);

      tb.innerHTML = arr.map(e=>{
        const smsUrl = `sms:+1${cleanPhone(e.phone||'')}?&body=${encodeURIComponent(`Hi ${e.preferredName||e.lastName||'there'}, could we stop by Wednesday evening?`)}`;
        return `<tr>
          <td>${(e.preferredName||'') + ' ' + (e.lastName||'')}</td>
          <td>${e.phone||''}</td>
          <td>${fmtDate(e.lastVisited)}</td>
          <td>${e.attemptsSinceLastVisit||0}</td>
          <td>
            <a class="btn outline" href="${smsUrl}">Text</a>
            <button class="btn" onclick="quickLogVisit('${e.id}')">Log</button>
            <button class="btn outline" onclick="editElder('${e.id}')">Edit</button>
            <button class="btn danger" onclick="archiveElder('${e.id}')">Archive</button>
          </td>
        </tr>`;
      }).join('');

      updateSortArrows();
    }

    function fillLogSelect(){
      const sel = q('logElderSelect');
      const arr = Array.from(elders.values()).filter(e=>e.active!==false).sort((a,b)=>(a.lastName||'').localeCompare(b.lastName||''));
      sel.innerHTML = arr.map(e=>`<option value="${e.id}">${(e.preferredName||'')+' '+(e.lastName||'')}</option>`).join('');
      if (!q('logDate').value) q('logDate').valueAsDate = new Date();
    }

    // Save visit
    window.saveVisit = async ()=>{
      const elderId = q('logElderSelect').value;
      const dateStr = q('logDate').value;
      const outcome = q('logOutcome').value;
      const visitors = q('logVisitors').value.trim();
      const notes = q('logNotes').value.trim();
      if (!elderId || !dateStr) return alert('Pick elder and date');
      const visit = { elderId, visitDate: dateStr, outcome, visitors, notes, createdAt: new Date() };
      await addDoc(userCol('visits'), visit);
      const ref = doc(db, 'users', currentUser.uid, 'elders', elderId);
      const isVisited = (outcome === 'Visited' || outcome === 'Scheduled');
      await updateDoc(ref, {
        lastVisited: isVisited ? new Date(dateStr) : serverTimestamp(),
        lastContacted: serverTimestamp(),
        attemptsSinceLastVisit: isVisited ? 0 : increment(1)
      });
      q('logNotes').value='';
      alert('Saved.');
    };

    window.quickLogVisit = async (elderId)=>{
      const ref = doc(db, 'users', currentUser.uid, 'elders', elderId);
      await updateDoc(ref, { lastVisited: serverTimestamp(), lastContacted: serverTimestamp(), attemptsSinceLastVisit: 0 });
      await addDoc(userCol('visits'), {
        elderId, visitDate: new Date().toISOString().slice(0,10),
        outcome: 'Visited', visitors: 'Presidency', notes:'(Quick log)', createdAt: new Date()
      });
    };

    window.noAnswer = async (elderId)=>{
      const ref = doc(db, 'users', currentUser.uid, 'elders', elderId);
      await updateDoc(ref, { lastContacted: serverTimestamp(), attemptsSinceLastVisit: increment(1) });
      await addDoc(userCol('visits'), {
        elderId, visitDate: new Date().toISOString().slice(0,10),
        outcome: 'No answer', visitors: 'Presidency', notes:'', createdAt: new Date()
      });
    };

    window.addElderPrompt = async ()=>{
      const name = prompt('Preferred name and last name (e.g., John Doe)?');
      if (!name) return;
      const phone = prompt('Phone (optional)') || '';
      const [preferredName, ...rest] = name.split(' ');
      const lastName = rest.join(' ');
      await addDoc(userCol('elders'), {
        preferredName, lastName, phone, active: true, firstSeen: new Date(),
        attemptsSinceLastVisit: 0, doNotText: false
      });
    };

    window.editElder = async (id)=>{
      const e = elders.get(id); if (!e) return;
      const name = prompt('Edit name', `${e.preferredName||''} ${e.lastName||''}`) || '';
      const phone = prompt('Edit phone', e.phone||'') || '';
      const doNotText = confirm('Mark as Do Not Text? Click OK for Yes, Cancel for No');
      const [preferredName, ...rest] = name.split(' ');
      const lastName = rest.join(' ');
      const ref = doc(db, 'users', currentUser.uid, 'elders', id);
      await updateDoc(ref, { preferredName, lastName, phone, doNotText });
    };

    window.archiveElder = async (id)=>{ if (!confirm('Archive this elder (set inactive)?')) return;
      await updateDoc(doc(db, 'users', currentUser.uid, 'elders', id), { active: false });
    };

    // ---------- Canonical keys (no householdId) ----------
    const keyFromDoc = (e) => [
      cleanPhone(e.phone||''), norm(e.email||''), norm((e.preferredName||'')+'|'+(e.lastName||''))
    ].join('|');
    const keyFromRow = (r) => [
      cleanPhone(r.Phone||r.phone||''), norm(r.Email||r.email||''), norm((r.PreferredName||r.FirstName||'')+'|'+(r.LastName||''))
    ].join('|');

    // ---------- Export backup ----------
    window.exportBackup = async ()=>{
      const [es, vs] = await Promise.all([ getDocs(userCol('elders')), getDocs(userCol('visits')) ]);
      const data = {
        elders: es.docs.map(d=>({id:d.id,...d.data()})),
        visits: vs.docs.map(d=>({id:d.id,...d.data()}))
      };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = 'eq-visit-backup.json'; a.click(); URL.revokeObjectURL(a.href);
    };

    // ---------- Export CSV ----------
    window.exportCsv = async ()=>{
      const snap = await getDocs(userCol('elders'));
      const rows = snap.docs.map(d=>{
        const e = { id:d.id, ...d.data() };
        const toIso = (t)=> t ? (t.toDate ? t.toDate().toISOString().slice(0,10) : new Date(t).toISOString().slice(0,10)) : '';
        return {
          PreferredName: e.preferredName || '',
          LastName:      e.lastName || '',
          Phone:         e.phone || '',
          Email:         e.email || '',
          Address:       e.address || '',
          DoNotText:     e.doNotText ? 'Yes' : 'No',
          Active:        e.active!==false ? 'Yes' : 'No',
          LastVisited:   toIso(e.lastVisited),
          LastContacted: toIso(e.lastContacted),
          Attempts:      e.attemptsSinceLastVisit || 0,
          Id:            e.id
        };
      });
      const csv = Papa.unparse(rows);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = 'elders_export.csv'; a.click(); URL.revokeObjectURL(a.href);
    };

    // ---------- Import (idempotent) ----------
    function parseCsv(file){
      return new Promise((resolve, reject)=>{
        Papa.parse(file, { header:true, skipEmptyLines:true,
          complete: (res)=>resolve(res.data), error: reject });
      });
    }

    window.importCsv = async ()=>{
      const file = q('csvFile').files[0];
      if (!file) return alert('Choose a CSV file.');
      const rows = await parseCsv(file);

      const snap = await getDocs(userCol('elders'));
      const existingByKey = new Map();
      snap.forEach(d=>{
        const e = {id:d.id, ...d.data()};
        existingByKey.set(keyFromDoc(e), e);
      });

      const seenKeys = new Set();

      for (const r of rows){
        const key = keyFromRow(r);
        seenKeys.add(key);

        const phone = cleanPhone(r.Phone||r.phone||'');
        const payload = {
          preferredName: r.PreferredName || r.FirstName || '',
          lastName: r.LastName || '',
          phone: phone || '',
          email: r.Email || '',
          address: r.Address || '',
          doNotText: ((r.DoNotText||'').toString().toLowerCase().startsWith('y')),
          active: true
        };

        const match = existingByKey.get(key);
        if (match){
          await updateDoc(doc(db,'users',currentUser.uid,'elders',match.id), payload);
        } else {
          const newId = hash(key); // deterministic id â†’ idempotent
          await setDoc(doc(db,'users',currentUser.uid,'elders',newId), { ...payload, firstSeen: new Date(), attemptsSinceLastVisit: 0 }, { merge:true });
          existingByKey.set(key, { id:newId, ...payload });
        }
      }

      // Mark missing as inactive (keep history)
      for (const [key, e] of existingByKey){
        if (!seenKeys.has(key)){
          await updateDoc(doc(db,'users',currentUser.uid,'elders',e.id), { active:false });
        }
      }
      alert('Import complete (idempotent).');
    };

    // ---------- Fix duplicates already in DB (phone OR email OR full name) ----------
    window.fixDuplicates = async ()=>{
      if (!confirm('Merge duplicates (preserve visit history)?')) return;
      const uid = currentUser?.uid; if (!uid) return alert('Sign in first.');

      const es = await getDocs(userCol('elders'));
      const items = es.docs.map(d=>({ id:d.id, ...d.data() }));

      // Union-Find clustering by phone, email, and full name
      const find = (p, x)=> (p[x]===x ? x : (p[x]=find(p, p[x])));
      const unite = (p, a, b)=>{ a=find(p,a); b=find(p,b); if (a!==b) p[b]=a; };

      const parent = {}; items.forEach(e=>parent[e.id]=e.id);
      const mapify = (getter)=> {
        const m = new Map();
        items.forEach(e=>{
          const k = getter(e);
          if (!k) return;
          if (!m.has(k)) m.set(k, []);
          m.get(k).push(e.id);
        });
        return m;
      };

      const byPhone = mapify(e=>cleanPhone(e.phone||''));
      const byEmail = mapify(e=>norm(e.email||''));
      const byName  = mapify(e=>norm((e.preferredName||'')+'|'+(e.lastName||'')));

      ;[byPhone, byEmail, byName].forEach(map=>{
        map.forEach(ids=>{
          for (let i=1;i<ids.length;i++) unite(parent, ids[0], ids[i]);
        });
      });

      const clusters = new Map();
      items.forEach(e=>{
        const r = find(parent, e.id);
        if (!clusters.has(r)) clusters.set(r, []);
        clusters.get(r).push(e);
      });

      let mergedCount = 0;

      const score = (e)=> (e.email?1:0)+(e.phone?1:0)+(e.address?1:0)+(e.active!==false?1:0)+(e.lastVisited?2:0)+(e.lastContacted?1:0)+((e.attemptsSinceLastVisit||0)>0?1:0);

      for (const [, group] of clusters){
        if (group.length <= 1) continue;

        // pick keeper
        let keep = group[0];
        for (const g of group.slice(1)){
          const sg = score(g), sk = score(keep);
          if (sg>sk || (sg===sk && asMs(g.lastVisited)>asMs(keep.lastVisited))) keep = g;
        }

        for (const dup of group){
          if (dup.id === keep.id) continue;

          // move visits
          const vs = await getDocs(query(userCol('visits'), where('elderId','==', dup.id)));
          for (const v of vs.docs){
            await updateDoc(doc(db,'users',uid,'visits',v.id), { elderId: keep.id });
          }

          // merge data
          const merged = {
            preferredName: keep.preferredName || dup.preferredName || '',
            lastName: keep.lastName || dup.lastName || '',
            phone: keep.phone || dup.phone || '',
            email: keep.email || dup.email || '',
            address: keep.address || dup.address || '',
            lastVisited: maxDate(keep.lastVisited, dup.lastVisited) || keep.lastVisited || dup.lastVisited || null,
            lastContacted: maxDate(keep.lastContacted, dup.lastContacted) || keep.lastContacted || dup.lastContacted || null,
            attemptsSinceLastVisit: Math.max(keep.attemptsSinceLastVisit||0, dup.attemptsSinceLastVisit||0),
            doNotText: !!(keep.doNotText || dup.doNotText),
            active: (keep.active!==false && dup.active!==false)
          };
          await updateDoc(doc(db,'users',uid,'elders',keep.id), merged);

          // delete dup
          await deleteDoc(doc(db,'users',uid,'elders',dup.id));
          mergedCount++;
        }
      }

      alert(`Fixed ${mergedCount} duplicate record(s).`);
    };

    // Pick this week
    window.pickThisWeek = async ()=>{
      const arr = Array.from(elders.values()).filter(e => e.active!==false && !e.doNotText);
      arr.forEach(e => e._score = nextUpScore(e));
      arr.sort((a,b)=> b._score - a._score);
      if (!arr.length) return alert('No eligible elders.');
      const chosen = arr[0];
      const monday = (() => { const x=new Date(); const day=x.getDay(); const diff=x.getDate()-day+(day==0?-6:1); x.setDate(diff); x.setHours(0,0,0,0); return x; })();
      await addDoc(userCol('schedule'), { weekOf:monday, elderId:chosen.id, elderName:(chosen.preferredName||'')+' '+(chosen.lastName||''), createdAt:new Date(), status:'Planned' });
      alert('Picked: ' + (chosen.preferredName||'') + ' ' + (chosen.lastName||'' ));
    };

    // Initial view + wire search inputs
    window.showView('next');
    wireSearch();
  </script>

  <!-- Firestore Security Rules (paste in Firebase Console)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{uid}/{collection}/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }
  }
  -->
</body>
</html>
